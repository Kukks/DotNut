name: 'Publish application'
on: push

jobs:
  tests: 
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - uses: actions/checkout@v5

      # Install .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Pull and start mint
        run: |
          docker run -d -p 3338:3338 \
          --name cdk-mint \
          -e CDK_MINTD_DATABASE=sqlite \
          -e CDK_MINTD_LN_BACKEND=fakewallet \
          -e CDK_MINTD_INPUT_FEE_PPK=100 \
          -e CDK_MINTD_LISTEN_HOST=0.0.0.0 \
          -e CDK_MINTD_LISTEN_PORT=3338 \
          -e CDK_MINTD_FAKE_WALLET_MIN_DELAY=0 \
          -e CDK_MINTD_MNEMONIC='abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about' \
          cashubtc/mintd:latest-amd64 \

      - name: Wait for mint to be ready
        run: |
          timeout 60s bash -c 'until curl -f localhost:3338/v1/info; do sleep 2; done'

      - name: Test
        run: dotnet test
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - uses: actions/checkout@v2

      # Install .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 8.0.x

      - name: Publish NuGet
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: Rebel028/publish-nuget@v2.7.0
        with:
          PROJECT_FILE_PATH: DotNut/DotNut.csproj
          NUGET_KEY: ${{secrets.NUGET_KEY}}
          PACKAGE_NAME: DotNut
          INCLUDE_SYMBOLS: false
          VERSION_REGEX: ^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$
          TAG_COMMIT: true
          TAG_FORMAT: DotNut/v*
      - name: Publish Github Package Registry
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: Rebel028/publish-nuget@v2.7.0
        with:
          PROJECT_FILE_PATH: DotNut/DotNut.csproj
          NUGET_SOURCE: "https://nuget.pkg.github.com/Kukks"
          NUGET_KEY: ${{secrets.GH_TOKEN}}
          PACKAGE_NAME: DotNut
          INCLUDE_SYMBOLS: false
          VERSION_REGEX: ^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$
          TAG_COMMIT: true
          TAG_FORMAT: DotNut/v*
      - name: Publish NuGet for nostr
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: Rebel028/publish-nuget@v2.7.0
        with:
          PROJECT_FILE_PATH: DotNut.Nostr/DotNut.Nostr.csproj
          NUGET_KEY: ${{secrets.NUGET_KEY}}
          PACKAGE_NAME: DotNut.Nostr
          INCLUDE_SYMBOLS: false
          VERSION_REGEX: ^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$
          TAG_COMMIT: true
          TAG_FORMAT: DotNut.Nostr/v*
      - name: Publish Github Package Registry for nostr
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: Rebel028/publish-nuget@v2.7.0
        with:
          PROJECT_FILE_PATH: DotNut.Nostr/DotNut.Nostr.csproj
          NUGET_SOURCE: "https://nuget.pkg.github.com/Kukks"
          NUGET_KEY: ${{secrets.GH_TOKEN}}
          PACKAGE_NAME: DotNut.Nostr
          INCLUDE_SYMBOLS: false
          VERSION_REGEX: ^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$
          TAG_COMMIT: true
          TAG_FORMAT: DotNut/v*